# react-native-mapbox-geometry-editor

Interactive shape editing on top of the Mapbox Maps SDK for React Native

## Example

Example app setup is described in [CONTRIBUTING.md](CONTRIBUTING.md).

## Installation

```sh
yarn add react-native-mapbox-geometry-editor @react-native-mapbox-gl/maps react-native-get-random-values
```

If you wish to use the default editing controls user interface (`<GeometryEditorUI/>`) from this library, then you must also install the peer dependency `react-native-vector-icons`.
Run `yarn add react-native-vector-icons`, and then follow the additional instructions listed [here](https://github.com/oblador/react-native-vector-icons#installation).
Note that there is no need to set up FontAwesome 5 support with `react-native-vector-icons`.

The unofficial Mapbox Maps SDK for React Native, `@react-native-mapbox-gl/maps` is a peer dependency.
To use it, you must have a [Mapbox API access token](https://docs.mapbox.com/help/how-mapbox-works/access-tokens/).

### Import options

#### Importing library builds (recommended)

The library provides builds to suit different transpilation mechanisms:

```js
// commonjs module system
import { GeometryEditorUI } from 'react-native-mapbox-geometry-editor/lib/commonjs';

// ES6 module system
// Useful for tree-shaking
import { GeometryEditorUI } from 'react-native-mapbox-geometry-editor/lib/module';

// TypeScript
import { GeometryEditorUI } from 'react-native-mapbox-geometry-editor/lib/typescript';
```

For more information about the build targets, see https://github.com/callstack/react-native-builder-bob#targets

#### Import library source (not recommended)

```js
import { GeometryEditorUI } from 'react-native-mapbox-geometry-editor';
```

The plain import will import the source code of the library, meaning that your code will need to be transpiled under Babel or TypeScript configurations that are compatible with those used to develop the library.

## Usage

```js
/**
 * Polyfill for React Native needed by 'react-native-mapbox-geometry-editor'
 * See https://github.com/uuidjs/uuid#getrandomvalues-not-supported
 */
import 'react-native-get-random-values';

import MapboxGeometryEditor from "react-native-mapbox-geometry-editor";

// ...
// TODO: Document a real example
const result = await MapboxGeometryEditor.multiply(3, 7);
```

## Geometry format and metadata

The library uses the [GeoJSON Feature](https://tools.ietf.org/html/rfc7946) format to communicate geometry with client applications.
GeoJSON Feature objects can be associated with arbitrary metadata, stored under a `"properties"` key.

The `<GeometryEditorUI/>` graphical interface for the library accepts a schema description that the library uses to build a form so that the user can edit geometry metadata in a type-safe manner.
The schema description is generated by the function passed to the `metadataSchemaGenerator` prop of `<GeometryEditorUI/>`.
If the schema description returned by the function is not `null`, it must be an object of the form parsed by [`@demvsystems/yup-ast`](https://github.com/demvsystems/yup-ast), subject to restrictions described below.

The schema description must contain a top-level object:
```TypeScript
[
    ['yup.object'],
    ['yup.required'],
    [
      'yup.shape',
      {
        // FIELDS
        fieldKey: [...] // FIELD SCHEMA
      },
    ],
  ]
```

The `FIELDS` portion contains the actual fields of the GeoJSON metadata.
The datatype of a field must be one of the following:
- `fieldKey: [['yup.mixed'], ['yup.oneOf', ["ARRAY", "OF", "STRINGS" ]],]`: A string-typed enumeration, where the array of possible values must have at least one element
- `fieldKey: [['yup.string']]`: A string
- `fieldKey: [['yup.number']]`: A number
- `fieldKey: [['yup.boolean']]`: A boolean

Fields with datatypes not in the above list will not appear in metadata forms, but can still be present in the metadata of objects imported by the library.
The library will only display and allow editing of fields of the supported types, and will leave other fields hidden and untouched.

The schema description can (and should) contain human-readable text to assist the user:
- Fields can be given human-readable names using the `'yup.label'` attribute.
  For example, `fieldKey: [['yup.boolean'], ['yup.label', 'Field name'],]` gives the field a name of `'Field name'`.
  If a label is not provided, the field name will default to the field's key.
- Constraints on fields beyond basic datatype constraints can be associated with custom error messages.
  For example, if a field's schema is `fieldKey: [['yup.string'], ['yup.required', 'This field is required'],]`, then if the user does not give the field a value, they will be shown the error message `'This field is required'`.

Refer to [the example app](./example/src/App.tsx) for an example of a complex metadata schema description.

The library provides the `validateMetadata()` utility function for validating the syntax of schema descriptions.
`validateMetadata()` can also test whether a given JavaScript object conforms to the input schema description.

## API Documentation

HTML API documentation for the library can be generated using Typedoc as follows:

1. Run `yarn bootstrap` in the root directory of the repository
2. Run `yarn docs`
3. Open `docs/src/index.html` in a web browser

## Known issues
- There are inconsistent performance issues with React Native Paper-based dialogs.
  Presently these issues seem to be observed only on iOS, and only with dialogs
  that need to manage some local state.
  A possibly related issue may be https://github.com/callstack/react-native-paper/issues/2157

### Android
- Geometry rendering on an Android emulator may exhibit visual problems such as rendering points in grey instead of in their desired colours.
  Zooming in and out on the map may make colours randomly appear and disappear.

### iOS
- To drag an editable point, it may be necessary to first tap on the point (press and release) before pressing and holding to drag the point.
- Editable points may snap back to their original positions while or after being dragged (https://github.com/react-native-mapbox-gl/maps/issues/1117).
- To draw a new point, it may be necessary to first tap on the map, to switch focus to the map, after having tapped on a geometry object or on a user interface element.
  In other words, two taps on the map may be required to draw a new point.

## Contributing

See the [contributing guide](CONTRIBUTING.md) to learn how to run the example app, and how to contribute to the repository.

## License

MIT
